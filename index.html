<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kirschtarmyliga 1.0</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-950 text-white min-h-screen">
<div class="max-w-6xl mx-auto p-6">

<h1 class="text-4xl font-bold text-center mb-8">
ğŸ¯ Kirschtarmyliga 1.0
</h1>

<!-- LOGIN -->
<div class="bg-gray-800 p-4 rounded-xl mb-6 text-center">
<input id="email" type="email" placeholder="E-Mail"
class="p-2 text-black rounded mb-2 w-64">
<input id="password" type="password" placeholder="Passwort"
class="p-2 text-black rounded mb-2 w-64">
<div class="mt-2">
<button onclick="login()" class="bg-green-600 px-4 py-2 rounded">Login</button>
<button onclick="logout()" id="logoutBtn"
class="bg-red-600 px-4 py-2 rounded hidden">Logout</button>
</div>
</div>

<!-- LIGA BUTTONS -->
<div class="flex flex-wrap justify-center gap-4 mb-6">
<button onclick="switchLiga('liga1')" class="bg-blue-600 px-4 py-2 rounded">Liga 1</button>
<button onclick="switchLiga('liga2')" class="bg-purple-600 px-4 py-2 rounded">Liga 2</button>
<button onclick="switchLiga('liga3')" class="bg-green-600 px-4 py-2 rounded">Liga 3</button>
<button onclick="switchLiga('liga4')" class="bg-red-600 px-4 py-2 rounded">Liga 4</button>
</div>

<h2 id="ligaTitle" class="text-2xl font-bold text-center mb-4"></h2>

<!-- SPIEL HINZUFÃœGEN -->
<div class="bg-gray-800 p-6 rounded-xl mb-8">
<h3 class="text-xl font-bold mb-4">ğŸ—“ Spiel hinzufÃ¼gen</h3>

<div class="grid grid-cols-2 gap-4 mb-4">
<input id="heimInput" placeholder="Heim"
class="text-black p-2 rounded">
<input id="gastInput" placeholder="Gast"
class="text-black p-2 rounded">
<input id="spieltagInput" type="number" placeholder="Spieltag"
class="text-black p-2 rounded">
<input id="resultInput" placeholder="Ergebnis z.B 6:4"
class="text-black p-2 rounded">
<input type="file" id="fileInput" class="text-white col-span-2">
</div>

<button id="addMatchBtn"
onclick="addMatch()"
class="bg-blue-600 px-4 py-2 rounded hidden">
Spiel speichern
</button>

<hr class="my-6 border-gray-600">

<table class="w-full text-center" id="matchTable">
<thead class="bg-gray-700">
<tr>
<th>Spieltag</th>
<th>Heim</th>
<th>Gast</th>
<th>Ergebnis</th>
<th>Datei</th>
<th id="deleteHeader" class="hidden">âŒ</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- TABELLE -->
<div class="bg-gray-800 p-6 rounded-xl">
<h3 class="text-xl font-bold mb-4">ğŸ“Š Tabelle</h3>

<table class="w-full text-center" id="leagueTable">
<thead class="bg-gray-700">
<tr>
<th>Team</th>
<th>Sp</th>
<th>S</th>
<th>U</th>
<th>Leg+</th>
<th>Leg-</th>
<th>Diff</th>
<th>P</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
apiKey: "AIzaSyDb87wTtntcY4VQ9WjekaA3CLYwW2bNrmQ",
authDomain: "kirschtarmyliga.firebaseapp.com",
projectId: "kirschtarmyliga",
storageBucket: "kirschtarmyliga.appspot.com",
messagingSenderId: "661130390257",
appId: "1:661130390257:web:469047a1dec589eb321750"
};

const ADMIN_EMAILS=["janblut18@gmail.com"];

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let currentLiga="liga1";
let isAdmin=false;
const matchesRef=collection(db,"matches");

window.login=async()=>await signInWithEmailAndPassword(auth,email.value,password.value);
window.logout=async()=>await signOut(auth);

onAuthStateChanged(auth,user=>{
if(user && ADMIN_EMAILS.includes(user.email)){
isAdmin=true;
addMatchBtn.classList.remove("hidden");
deleteHeader.classList.remove("hidden");
logoutBtn.classList.remove("hidden");
}else{
isAdmin=false;
addMatchBtn.classList.add("hidden");
deleteHeader.classList.add("hidden");
logoutBtn.classList.add("hidden");
}
});

window.switchLiga=liga=>{
currentLiga=liga;
ligaTitle.innerText="Liga "+liga.replace("liga","");
loadMatches();
};

window.addMatch=async()=>{
if(!isAdmin)return;

let fileURL="";

if(fileInput.files.length>0){
const file=fileInput.files[0];
const storageRef=ref(storage,"spiele/"+Date.now()+"_"+file.name);
await uploadBytes(storageRef,file);
fileURL=await getDownloadURL(storageRef);
}

await addDoc(matchesRef,{
liga:currentLiga,
spieltag:Number(spieltagInput.value)||1,
heim:heimInput.value,
gast:gastInput.value,
result:resultInput.value,
file:fileURL
});
};

function loadMatches(){
onSnapshot(matchesRef,snap=>{
matchTable.querySelector("tbody").innerHTML="";
let tableData={};

snap.forEach(docSnap=>{
const m=docSnap.data();
if(m.liga!==currentLiga)return;

matchTable.querySelector("tbody").innerHTML+=`
<tr>
<td>${m.spieltag}</td>
<td>${m.heim}</td>
<td>${m.gast}</td>
<td>${m.result}</td>
<td>${m.file?`<a href="${m.file}" target="_blank" class="text-blue-400 underline">Ã–ffnen</a>`:"-"}</td>
${isAdmin?`<td><button onclick="deleteMatch('${docSnap.id}')" class="text-red-400">X</button></td>`:""}
</tr>`;

if(!m.result.includes(":"))return;
let [h,a]=m.result.split(":").map(Number);

if(!tableData[m.heim])tableData[m.heim]={spiele:0,siege:0,unentschieden:0,legsPlus:0,legsMinus:0,punkte:0};
if(!tableData[m.gast])tableData[m.gast]={spiele:0,siege:0,unentschieden:0,legsPlus:0,legsMinus:0,punkte:0};

tableData[m.heim].spiele++;
tableData[m.gast].spiele++;
tableData[m.heim].legsPlus+=h;
tableData[m.heim].legsMinus+=a;
tableData[m.gast].legsPlus+=a;
tableData[m.gast].legsMinus+=h;

if(h>a){tableData[m.heim].siege++;tableData[m.heim].punkte+=3;}
else if(h<a){tableData[m.gast].siege++;tableData[m.gast].punkte+=3;}
else{tableData[m.heim].unentschieden++;tableData[m.gast].unentschieden++;tableData[m.heim].punkte+=1;tableData[m.gast].punkte+=1;}
});

const teams=Object.keys(tableData).sort((a,b)=>{
if(tableData[b].punkte!==tableData[a].punkte)
return tableData[b].punkte-tableData[a].punkte;
return (tableData[b].legsPlus-tableData[b].legsMinus)-(tableData[a].legsPlus-tableData[a].legsMinus);
});

leagueTable.querySelector("tbody").innerHTML="";

teams.forEach((team,index)=>{
let d=tableData[team];
leagueTable.querySelector("tbody").innerHTML+=`
<tr>
<td>${team}</td>
<td>${d.spiele}</td>
<td>${d.siege}</td>
<td>${d.unentschieden}</td>
<td>${d.legsPlus}</td>
<td>${d.legsMinus}</td>
<td>${d.legsPlus-d.legsMinus}</td>
<td>${d.punkte}</td>
</tr>`;
});
});
}

window.deleteMatch=async id=>await deleteDoc(doc(db,"matches",id));

switchLiga("liga1");
</script>
</body>
</html>
