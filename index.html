<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kirschtarmy 1.0</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen">
<div class="max-w-6xl mx-auto p-6">

<h1 class="text-4xl font-bold text-center mb-8">
ğŸ¯ Kirschtarmy 1.0
</h1>

<!-- LOGIN -->
<div class="bg-gray-800 p-4 rounded-xl mb-6 text-center">
<input id="email" type="email" placeholder="Email"
class="p-2 text-black rounded mb-2 w-64">
<input id="password" type="password" placeholder="Passwort"
class="p-2 text-black rounded mb-2 w-64">
<div>
<button id="loginBtn" class="bg-green-600 px-4 py-2 rounded">Login</button>
<button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded">Logout</button>
</div>
<p id="loginStatus" class="mt-2 text-sm text-red-400"></p>
</div>

<!-- LIGA BUTTONS -->
<div class="flex justify-center gap-4 mb-6">
<button data-liga="liga1" class="ligaBtn bg-blue-600 px-4 py-2 rounded">Liga 1</button>
<button data-liga="liga2" class="ligaBtn bg-purple-600 px-4 py-2 rounded">Liga 2</button>
<button data-liga="liga3" class="ligaBtn bg-green-600 px-4 py-2 rounded">Liga 3</button>
<button data-liga="liga4" class="ligaBtn bg-red-600 px-4 py-2 rounded">Liga 4</button>
</div>

<h2 id="ligaTitle" class="text-2xl font-bold text-center mb-4"></h2>

<!-- SPIELER -->
<div class="bg-gray-800 p-6 rounded-xl mb-8">
<h3 class="text-xl font-bold mb-4">ğŸ‘¥ Spieler</h3>
<ul id="playerList" class="mb-4 space-y-2"></ul>
<button id="addPlayerBtn" class="bg-green-600 px-4 py-2 rounded hidden">
â• Spieler hinzufÃ¼gen
</button>
</div>

<!-- SPIEL -->
<div class="bg-gray-800 p-6 rounded-xl mb-8">
<h3 class="text-xl font-bold mb-4">ğŸ—“ Spiel hinzufÃ¼gen</h3>

<div class="grid grid-cols-2 gap-4 mb-4">
<select id="heimSelect" class="text-black p-2 rounded"></select>
<select id="gastSelect" class="text-black p-2 rounded"></select>
<input id="spieltagInput" type="number" placeholder="Spieltag"
class="text-black p-2 rounded">
<input id="resultInput" placeholder="Ergebnis 6:4"
class="text-black p-2 rounded">
</div>

<button id="addMatchBtn" class="bg-blue-600 px-4 py-2 rounded hidden">
Spiel speichern
</button>

<hr class="my-6 border-gray-600">

<table class="w-full text-center">
<thead class="bg-gray-700">
<tr>
<th>Spieltag</th>
<th>Heim</th>
<th>Gast</th>
<th>Ergebnis</th>
<th id="deleteHeader" class="hidden">âŒ</th>
</tr>
</thead>
<tbody id="matchTable"></tbody>
</table>
</div>

<!-- TABELLE -->
<div class="bg-gray-800 p-6 rounded-xl">
<h3 class="text-xl font-bold mb-4">ğŸ“Š Tabelle</h3>
<table class="w-full text-center">
<thead class="bg-gray-700">
<tr>
<th>Team</th>
<th>Sp</th>
<th>S</th>
<th>U</th>
<th>Leg+</th>
<th>Leg-</th>
<th>Diff</th>
<th>P</th>
</tr>
</thead>
<tbody id="leagueTable"></tbody>
</table>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDb87wTtntcY4VQ9WjekaA3CLYwW2bNrmQ",
  authDomain: "kirschtarmyliga.firebaseapp.com",
  projectId: "kirschtarmyliga",
  storageBucket: "kirschtarmyliga.firebasestorage.app",
  messagingSenderId: "661130390257",
  appId: "1:661130390257:web:469047a1dec589eb321750"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentLiga="liga1";
let isAdmin=false;

const admins = [
  "janblut18@gmail.com",
  "jaqueline.zeiser@web.de"
];

loginBtn.onclick = async ()=>{
try{
await signInWithEmailAndPassword(auth,email.value,password.value);
loginStatus.innerText="Erfolgreich eingeloggt";
}catch(e){
loginStatus.innerText=e.message;
}
};

logoutBtn.onclick = ()=> signOut(auth);

onAuthStateChanged(auth,(user)=>{
if(user && admins.includes(user.email)){
isAdmin=true;
addPlayerBtn.classList.remove("hidden");
addMatchBtn.classList.remove("hidden");
deleteHeader.classList.remove("hidden");
}else{
isAdmin=false;
addPlayerBtn.classList.add("hidden");
addMatchBtn.classList.add("hidden");
deleteHeader.classList.add("hidden");
}
});

document.querySelectorAll(".ligaBtn").forEach(btn=>{
btn.onclick=()=>switchLiga(btn.dataset.liga);
});

addPlayerBtn.onclick = async ()=>{
const name=prompt("Spielername:");
if(!name) return;
await addDoc(collection(db,currentLiga+"_players"),{name});
loadData();
};

addMatchBtn.onclick = async ()=>{
await addDoc(collection(db,currentLiga+"_matches"),{
spieltag:spieltagInput.value,
heim:heimSelect.value,
gast:gastSelect.value,
result:resultInput.value
});
loadData();
};

async function switchLiga(liga){
currentLiga=liga;
ligaTitle.innerText="Liga "+liga.replace("liga","");
loadData();
}

async function loadData(){

playerList.innerHTML="";
heimSelect.innerHTML="";
gastSelect.innerHTML="";
matchTable.innerHTML="";
leagueTable.innerHTML="";
let tableData={};

const playersSnap=await getDocs(collection(db,currentLiga+"_players"));
playersSnap.forEach(d=>{
const p=d.data().name;
let li=document.createElement("li");
li.className="flex justify-between bg-gray-700 p-2 rounded";
li.innerHTML=p;

if(isAdmin){
let btn=document.createElement("button");
btn.innerText="X";
btn.className="text-red-400";
btn.onclick=async ()=>{ await deleteDoc(doc(db,currentLiga+"_players",d.id)); loadData(); };
li.appendChild(btn);
}

playerList.appendChild(li);
heimSelect.innerHTML+=`<option>${p}</option>`;
gastSelect.innerHTML+=`<option>${p}</option>`;
tableData[p]={spiele:0,siege:0,unentschieden:0,legsPlus:0,legsMinus:0,punkte:0};
});

const matchSnap=await getDocs(collection(db,currentLiga+"_matches"));
matchSnap.forEach(d=>{
const m=d.data();
let row=document.createElement("tr");
row.innerHTML=`
<td>${m.spieltag}</td>
<td>${m.heim}</td>
<td>${m.gast}</td>
<td>${m.result}</td>
`;
if(isAdmin){
let del=document.createElement("td");
let btn=document.createElement("button");
btn.innerText="X";
btn.className="text-red-400";
btn.onclick=async ()=>{ await deleteDoc(doc(db,currentLiga+"_matches",d.id)); loadData(); };
del.appendChild(btn);
row.appendChild(del);
}
matchTable.appendChild(row);

if(!m.result.includes(":")) return;
let [h,a]=m.result.split(":").map(Number);

tableData[m.heim].spiele++;
tableData[m.gast].spiele++;
tableData[m.heim].legsPlus+=h;
tableData[m.heim].legsMinus+=a;
tableData[m.gast].legsPlus+=a;
tableData[m.gast].legsMinus+=h;

if(h>a){tableData[m.heim].siege++;tableData[m.heim].punkte+=3;}
else if(h<a){tableData[m.gast].siege++;tableData[m.gast].punkte+=3;}
else{
tableData[m.heim].unentschieden++;
tableData[m.gast].unentschieden++;
tableData[m.heim].punkte+=1;
tableData[m.gast].punkte+=1;
}
});

let teams=Object.keys(tableData).sort((a,b)=>{
if(tableData[b].punkte!==tableData[a].punkte)
return tableData[b].punkte-tableData[a].punkte;
return (tableData[b].legsPlus-tableData[b].legsMinus)-
(tableData[a].legsPlus-tableData[a].legsMinus);
});

let liga=parseInt(currentLiga.replace("liga",""));
let last=teams.length-1;
let secondLast=teams.length-2;

teams.forEach((team,index)=>{
let d=tableData[team];
let rowClass="";

if(liga===1){
if(index===secondLast) rowClass="bg-yellow-500 text-black";
if(index===last) rowClass="bg-red-600";
}
if(liga===2){
if(index===0) rowClass="bg-green-600";
if(index===secondLast) rowClass="bg-yellow-500 text-black";
if(index===last) rowClass="bg-red-600";
}
if(liga===3){
if(index===0) rowClass="bg-green-600";
if(index===secondLast) rowClass="bg-yellow-500 text-black";
if(index===last) rowClass="bg-red-600";
}
if(liga===4){
if(index===0) rowClass="bg-green-600";
if(index===1) rowClass="bg-yellow-500 text-black";
}

leagueTable.innerHTML+=`
<tr class="${rowClass}">
<td>${team}</td>
<td>${d.spiele}</td>
<td>${d.siege}</td>
<td>${d.unentschieden}</td>
<td>${d.legsPlus}</td>
<td>${d.legsMinus}</td>
<td>${d.legsPlus-d.legsMinus}</td>
<td>${d.punkte}</td>
</tr>`;
});
}

switchLiga("liga1");

</script>
</body>
</html>
